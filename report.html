<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Accessibility Violations Report</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .card-violation {
            cursor: pointer;
        }

        .html-snippet {
            white-space: pre-wrap;
            word-break: break-word;
            background: #f8f9fa;
            padding: .75rem;
            border-radius: .25rem;
            border: 1px solid #e9ecef;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-4">
        <header class="d-flex align-items-start justify-content-between mb-4">
            <div>
                <h1 class="h3 mb-0">Accessibility Report</h1>
                <div id="site-url" class="text-muted small"></div>
            </div>
            <div class="text-end">
                <div class="small text-muted">Violations found</div>
                <div id="violation-count" class="fs-4 fw-bold">â€”</div>
            </div>
        </header>

        <div id="status" class="mb-3 text-muted small" aria-live="polite"></div>

        <main id="violations" class="row g-3"></main>
    </div>



    <script>
        const json_path = 'violations.json'; // Path to JSON - adjust if we change location

        const container = document.getElementById('violations');
        const count = document.getElementById('violation-count');
        const siteUrl = document.getElementById('site-url');
        const status = document.getElementById('status');

        function severityClass(impact) {
            if (!impact) return 'secondary';
            const i = impact.toLowerCase();
            if (i.includes('serious') || i.includes('critical') || i.includes('high')) return 'danger';
            if (i.includes('moderate') || i.includes('medium')) return 'warning';
            return 'secondary';
        }

        // escape to avoid messing up structure with the HTML snippets from JSON
        function escapeHtml(s) {
            if (s == null) return '';
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function render(data) {
            if (!Array.isArray(data)) data = [];
            count.textContent = data.length;
            container.innerHTML = '';
            status.textContent = data.length === 0 ? 'No violations found.' : `${data.length} violation(s) loaded from ${json_path}.`;

            data.forEach((rule, idx) => {
                const color = severityClass(rule.impact);
                const col = document.createElement('div');
                col.className = 'col-12 col-md-6';

                // Card for each violation
                const card = document.createElement('div');
                card.className = `card card-violation shadow-sm h-100 border-3 border-${color}`;
                card.tabIndex = 0;
                card.setAttribute('role', 'group');
                card.setAttribute('aria-labelledby', `violation-${idx}-title`);

                const cardBody = document.createElement('div');
                cardBody.className = `d-flex`;

                const content = document.createElement('div');
                content.className = 'flex-grow-1 p-3';

                // title for the violation
                const h5 = document.createElement('h5');
                h5.id = `violation-${idx}-title`;
                h5.className = 'card-title mb-1 d-flex align-items-center justify-content-between';

                const spanTitle = document.createElement('span');
                spanTitle.textContent = rule.help?.trim() || rule.description?.trim() || 'Untitled rule';

                // Open/close symbol
                const chev = document.createElement('i');
                chev.className = 'bi bi-chevron-down';
                chev.style.transition = 'transform .2s';
                h5.appendChild(spanTitle);
                h5.appendChild(chev);

                // Row containing 'metadata', i.e. severity and tags 
                const metaRow = document.createElement('div');
                metaRow.className = 'd-flex align-items-center mb-2 gap-2 flex-wrap';

                const impactBadge = document.createElement('span');
                impactBadge.className = `badge bg-${color} text-${color === 'warning' ? 'dark' : 'light'}`; //Sets text to dark if bg is warning (yellow) for visibility
                impactBadge.textContent = rule.impact ? rule.impact : 'n/a';

                const tags = document.createElement('span');
                tags.className = 'text-muted small';
                tags.innerHTML = `<strong>Tags:</strong> ${escapeHtml((rule.tags || []).join(', '))}`;

                metaRow.appendChild(impactBadge);
                metaRow.appendChild(tags);

                // Text to help explain the violation and link to Deque documentation for the rule
                const help = document.createElement('p');
                help.className = 'card-text mb-2 small text-muted';
                const helpText = escapeHtml(rule.help || rule.description || '');
                const helpUrl = escapeHtml(rule.helpUrl || '#');
                help.innerHTML = `${helpText} <a href="${helpUrl}" target="_blank" rel="noopener">Learn more</a>`;

                // selector badges for all targets in all nodes
                const targetsWrap = document.createElement('div');
                targetsWrap.className = 'card-text mb-2 small text-muted';
                targetsWrap.textContent = 'Affected selectors: ';
                targetsWrap.appendChild(document.createElement('br'));
                (rule.nodes || []).forEach(node => {
                    (node.target || []).forEach(t => {
                        const pill = document.createElement('span');
                        pill.className = 'badge bg-secondary rounded-pill me-1';
                        pill.textContent = t;
                        pill.setAttribute('title', 'Affected selector: ' + t); //tooltip for explaining what the hell this does
                        targetsWrap.appendChild(pill);
                    });
                });

                // container for nodes (hidden until clicked)
                const nodesContainer = document.createElement('div');
                nodesContainer.className = 'mt-3';
                nodesContainer.style.display = 'none';

                // nodes and snippets
                (rule.nodes || []).forEach(node => {
                    const nodeBox = document.createElement('div');
                    nodeBox.className = 'mb-3';

                    const fs = document.createElement('div');
                    fs.className = 'small text-muted';
                    fs.textContent = node.failureSummary || '';
                    nodeBox.appendChild(fs);

                    const snippets = [];
                    if (Array.isArray(node.relatedNodes)) {
                        node.relatedNodes.forEach(r => snippets.push({ target: (r.target || []).join(', '), html: r.html }));
                    }
                    ['none', 'any', 'all'].forEach(k => {
                        if (Array.isArray(node[k])) {
                            node[k].forEach(child => {
                                if (Array.isArray(child.relatedNodes)) {
                                    child.relatedNodes.forEach(r => snippets.push({ target: (r.target || []).join(', '), html: r.html }));
                                }
                            });
                        }
                    });

                    snippets.forEach(s => {
                        const t = document.createElement('div');
                        t.className = 'small mb-1';
                        t.textContent = `Target: ${s.target}`;
                        const pre = document.createElement('div');
                        pre.className = 'html-snippet';
                        pre.textContent = s.html || '';
                        nodeBox.appendChild(t);
                        nodeBox.appendChild(pre);
                    });

                    nodesContainer.appendChild(nodeBox);
                });

                // add content
                content.appendChild(h5);
                content.appendChild(metaRow);
                content.appendChild(help);
                content.appendChild(targetsWrap);
                content.appendChild(nodesContainer);

                cardBody.appendChild(content);
                card.appendChild(cardBody);

                // toggle visible/hidden for nodes on click, enter or space
                card.addEventListener('click', () => {
                    const nowVisible = nodesContainer.style.display === 'none' || nodesContainer.style.display === '';
                    nodesContainer.style.display = nowVisible ? 'block' : 'none';
                    card.classList.toggle('border-3');
                    chev.style.transform = nowVisible ? 'rotate(180deg)' : 'rotate(0deg)';
                });
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        card.click();
                    }
                });

                col.appendChild(card);
                container.appendChild(col);
            });
        }

        // Load JSON file
        async function loadAndRender() {
            status.textContent = 'Loading ' + json_path + ' â€¦';
            try {
                const resp = await fetch(json_path, { cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
                const json = await resp.json();

                let data = [];
                if (Array.isArray(json)) data = json;
                else if (json && Array.isArray(json.violations)) data = json.violations;
                else {
                    if (json && typeof json === 'object') {
                        for (const k of Object.keys(json)) {
                            if (Array.isArray(json[k]) && json[k].length > 0 && json[k][0].id) { data = json[k]; break; }
                        }
                    }
                }

                render(data);
            } catch (err) {
                status.textContent = 'Error loading ' + json_path + ': ' + err.message;
                count.textContent = '-';
                console.error(err);
            }
        }

        loadAndRender();
    </script>
</body>

</html>